## [5.0.0] 2025-11-21 — Добавлен Ruff (lint, format) и улучшенный CI, масштабное улучшение логирования во всём проекте

### Добавлено
- **Централизованная система логирования** (`utils/logger.py`):
  - Декоратор `@log_execution` для автоматического логирования начала, завершения и ошибок функций/методов.
  - Декоратор `@log_all_methods()` для автоматического применения логирования ко всем методам класса.
  - Автоматическое форматирование аргументов функций в логах (исключая `self`/`cls` для читаемости).
  - Поддержка как синхронных, так и асинхронных функций/методов.
  - Автоматическое логирование ошибок с `exc_info=True` для полного стека вызовов.
- **Полное покрытие логированием всех модулей**:
  - `main.py`: логирование всех методов `BotRunner` (инициализация, запуск, остановка, обработка сигналов, очистка ресурсов).
  - `bot/handlers.py`: логирование всех команд и методов `CommandHandlers` (21 метод).
  - `bot/wednesday_bot.py`: логирование всех методов основного бота (инициализация, настройка обработчиков, отправка сообщений, запуск/остановка).
  - `bot/support_bot.py`: логирование всех методов резервного бота (инициализация, команды, запуск/остановка).
  - `services/image_generator.py`: логирование всех методов генератора изображений (генерация, проверка API, работа с моделями).
  - `services/prompt_generator.py`: логирование всех методов клиента GigaChat (получение токенов, генерация промптов, работа с моделями).
  - `services/scheduler.py`: логирование всех методов планировщика задач (планирование, проверка задач, запуск/остановка).
  - `utils/*.py`: логирование всех методов хранилищ и утилит (`ChatsStore`, `AdminsStore`, `UsageTracker`, `Metrics`, `ModelsStore`, `DispatchRegistry`).
- Добавлена полноценная интеграция Ruff.
- Включены расширенные правила (Bugbear, Comprehensions, Annotations и др.).
- Настроены форматирование, сортировка импортов и автоисправление.
- Создан Makefile с едиными командами для разработчиков.
- Добавлен новый reusable workflow GitHub Actions для линтинга.
- Интегрирован Ruff в основной CI-пайплайн.

### Изменено
- **Улучшена детализация логов**:
  - Каждая функция/метод логирует начало выполнения с параметрами.
  - Успешное завершение функций логируется с результатами (где применимо).
  - Все ошибки логируются с полным стеком вызовов через `exc_info=True`.
  - Логирование важных изменений состояния (изменение флагов, сохранение данных, отправка сообщений).
  - Логирование до и после ключевых `await` вызовов в async функциях.
- **Структура логов**:
  - Единый формат логов с указанием функции, параметров и результатов.
  - Исключение служебных параметров (`self`, `cls`) из логов для улучшения читаемости.
  - Автоматическое форматирование сложных объектов (словари, списки) в логах.

### Исправлено
- Исправлен тест `test_generate_prompt_success`: добавлен метод `_clean_prompt` в мок-класс `_DummyGigaChatClient` в `tests/conftest.py` для корректной обработки промптов в тестах.
- Исправлен тест `test_schedule_methods_register_tasks`: согласовано время выполнения задач (`12:00`) и интервал (`60` минут) между регистрацией задач и проверками в тесте.
- Исправлен тест `test_mypy_config_present`: обновлён для проверки конфигурации mypy через секцию `[tool.mypy]` в `pyproject.toml` вместо отдельного файла `mypy.ini`.
- **services/scheduler.py:188**: Исправлена передача аргумента `slot_time` в функцию `send_wednesday_frog` — изменено с keyword argument на positional argument для соответствия сигнатуре функции.
- **tests/test_services/test_prompt_generator.py**: Исправлены ошибки присвоения методов и использования `assert_called_once`:
  - Заменено прямое присвоение `client.session.post = MagicMock(...)` на использование `monkeypatch.setattr()` для корректной типизации.
  - Исправлено использование `assert_called_once()` на объекте типа `Callable` — теперь используется mock-объект напрямую.
  - Обновлены тесты `test_get_access_token_success`, `test_get_access_token_bad_status`, `test_get_access_token_timeout`, `test_generate_prompt_success`.
- **bot/handlers.py:753**: Добавлена проверка на `None` для `status_message` перед вызовом метода `delete()` для предотвращения ошибки `Item "None" of "Message | None" has no attribute "delete"`.
- **bot/wednesday_bot.py:359, 396, 397**: Исправлены несовместимые типы аргументов и присвоений:
  - Исправлено определение `error_details` на строке 351 — убрана запятая в конце, чтобы переменная имела тип `str` вместо `tuple[str]`.
  - Исправлен вызов `_send_admin_error()` — теперь передаётся строка вместо tuple.
  - Исправлен вызов `logger.error()` — теперь передаётся строка вместо tuple.
- **main.py:119**: Исправлен тип аргумента `request_start_main` для `SupportBot`:
  - Функция `request_start_main` теперь объявлена как `async def` для соответствия ожидаемому типу `Callable[[dict[str, Any]], Awaitable[None]]`.

---

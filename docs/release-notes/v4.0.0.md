## [4.0.0] 2025-11-15

### Добавлено
- Полная типизация проекта с использованием mypy и PEP 484/604:
  - Добавлены аннотации типов во всех модулях: `bot/wednesday_bot.py`, `bot/support_bot.py`, `bot/handlers.py`, `services/image_generator.py`, `services/prompt_generator.py`, `services/scheduler.py`, `utils/*.py`, `main.py`.
  - Создан `mypy.ini` с строгими правилами проверки типов (`disallow_untyped_defs`, `disallow_incomplete_defs`).
  - Добавлены диагностические тесты `tests/test_typing.py` для проверки корректности типизации в CI.
  - Использование современных типов: `Optional`, `Union`, `Callable`, `List`, `Dict`, `Tuple`, `Set`, `Literal`, `Protocol`, `Final`.
  - Типизация Telegram-бота: корректные типы для `Update`, `ContextTypes`, `Message`, `Chat`, `User`.
  - Безопасная работа с Optional: добавлены проверки на `None` для `update.message`, `update.effective_user`, `update.effective_chat` во всех обработчиках.
  - Типизация асинхронных операций: корректные типы для `async def` функций и `Callable[[], Awaitable[None]]`.
  - Типизация хранилищ данных: корректные типы для JSON-хранилищ (`Dict[str, Any]`, `TypedDict` где применимо).
  - Типизация HTTP-клиентов: `aiohttp.ProxyConnector`, `aiohttp.ClientSession` с правильными типами.
  - Вспомогательный метод `ImageGenerator._get_auth_headers()` для безопасного получения заголовков авторизации с проверкой ключей.
- Автоматическая отправка результатов тестов в Codecov при push и PR.
- Каркас автоматических тестов:
  - Структура `tests/` с юнит-тестами для `utils.config`, `services.prompt_generator`, `services.image_generator` и Telegram-обработчиков.
  - `pytest.ini` с настройками запуска и добавлением корня проекта в `PYTHONPATH`.
  - GitHub Actions workflow `.github/workflows/ci.yml` для прогонов тестов и проверки типов при `push`/`pull request`.
- Фикстуры `pytest`:
  - Сессионная фикстура для подстановки обязательных переменных окружения, позволяющая запускать тесты без `.env`.
  - In-memory замены `ModelsStore` и `AdminsStore`, заглушка `GigaChatClient`, моки Telegram-контекста.
- Документация тестов `tests/README.md` с инструкциями по локальному запуску.
- Дополнительные модульные тесты: покрытие ключевых обработчиков (`CommandHandlers`, `WednesdayBot`, `SupportBot`), а также утилит `models_store.py`, `usage_tracker.py` и планировщика задач.

### Изменено
- Типы возвращаемых значений в `utils/config.py`: свойства `telegram_token`, `kandinsky_api_key`, `kandinsky_secret_key`, `chat_id` теперь возвращают `Optional[str]` вместо `str` для корректной типизации.
- Добавлены проверки и assert для обязательных конфигурационных значений при инициализации ботов.
- Улучшена типизация контекста: `on_my_chat_member` теперь использует `ContextTypes.DEFAULT_TYPE` вместо `Any`.
- Все обработчики команд проверяют наличие `update.message` и `update.effective_user` перед использованием.
- `tests/conftest.py` расширен дополнительными фикстурами для валидной инициализации сервисов и очистки окружения между тестами.
- Тесты `test_config_missing_required_env`, `test_prompt_generator`, `test_image_generator` скорректированы для корректной обработки ошибок и моков.
- Workflow CI/CD переработан:
  - Основной workflow `ci.yml` разделён на отдельные job'ы: `type-check` (проверка типов через mypy) и `test` (запуск pytest с покрытием).
  - Добавлена отправка результатов тестов (junit.xml) в Codecov через `codecov/test-results-action@v1`.
  - Настроен полный отчёт о покрытии кода (XML и терминальный формат) с интеграцией в Codecov.

### Исправлено
- Исправлены ошибки типизации: все функции имеют явные аннотации return type и argument type.
- Исправлены несовместимые типы: `str | None` вместо `str` где применимо, удалены возвраты `Any` где возможно.
- Исправлены union-attr ошибки: добавлены проверки на `None` для Optional атрибутов (`update.message`, `status_message`, `next_run`, `self.bot`, и т.д.).
- Исправлены ошибки override сигнатур: все переопределения методов соответствуют сигнатурам родительских классов.
- Исправлены неправильные типы переменных: добавлены явные аннотации для `connector`, `candidates`, `models_list`, `api_models`, `targets`, `chat_id_val`, `pipeline_id`, `uuid_value` и других переменных.
- Исправлены проблемы в `image_generator`:
  - Корректная типизация для `aiohttp.ProxyConnector.from_url()` с использованием `type: ignore[attr-defined]` для совместимости с mypy.
  - Создан метод `_get_auth_headers()` для безопасного получения заголовков авторизации с проверкой ключей API.
  - Добавлено явное приведение к `str` для значений, полученных из API ответов (pipeline_id, uuid) для устранения возврата `Any`.
- Исправлены ошибки `no-redef`: переименованы локальные переменные (`chat_id_val` → `chat_id_error_val`, `model_name` → `matched_model_name`/`selected_model_name`, `pipeline_id` → `selected_pipeline_id`) для избежания конфликтов имён в одной области видимости.
- Исправлены ошибки `method-assign` в тестах: использование `monkeypatch.setattr()` вместо прямого присваивания методов для корректной типизации моков (`test_prompt_generator`, `test_image_generator`).
- Исправлены проблемы с `Generator` фикстурами: добавлены явные типы возврата `Generator[None, None, None]` для всех фикстур в `tests/conftest.py`.
- Исправлена сигнатура `ModelsStore.set_kandinsky_available_models`: теперь поддерживает `List[Dict[str, Any]] | List[str]` для совместимости с тестами.
- Исправлена обработка `last_error` в `CommandHandlers._retry_on_connect_error`: добавлена проверка на `None` перед `raise` для корректной типизации.
- Исправлена типизация `chats_info` в `CommandHandlers.status_command`: изменён тип на `str | int` для поддержки как строковых, так и числовых значений.
- Исправлены проблемы с проверкой `models_data` в `GigaChatClient.get_available_models`: добавлена проверка на `None` перед итерацией.
- Устранены потенциальные ошибки при работе с Optional значениями: добавлены проверки перед вызовом методов (например, `status_message.delete()`, `next_run.weekday()`, `updater.start_polling()`).
- Исключены `ModuleNotFoundError` при запуске `pytest` за счёт добавления `pythonpath = .`.
- Исправлены `AttributeError` в тестах, связанных с моками `ModelsStore`, `GigaChatClient`, `Path.write_bytes`.
- Устранён `ValueError` при повторной инициализации `Config` в teardown благодаря восстановлению переменных окружения в тестах.
- Исправлен `SyntaxWarning` в `tests/conftest.py`: убран `return None` из `finally` блока в фикстуре `reload_config`.

---

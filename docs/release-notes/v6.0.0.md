## [6.0.0] 2025-12-02 — Обновлён CI, улучшена работа с GigaChat-промптами и fallback-механизм, добавлена Redis-интеграция для временного состояния и кэширования, миграция персистентных данных в PostgreSQL завершена, обновлены тесты и инфраструктура, значительно увеличено покрытие тестами, добавлены Docker volumes для файловых операций, нормализация и безопасная запись файлов промптов GigaChat

### Добавлено
- **Расширенное тестовое покрытие**:
  - `tests/test_bot/test_handlers.py` — добавлено 20+ новых тестов для команд:
    - `set_frog_used_command` — тесты успешного выполнения, неверных параметров и отсутствия аргументов
    - `unknown_command` — тест обработки неизвестных команд
    - `admin_add_chat_command` — тесты успешного добавления, отсутствия аргументов и неверного chat_id
    - `admin_remove_chat_command` — тесты успешного удаления и отсутствия аргументов
    - `list_chats_command` — тесты успешного вывода списка и пустого списка чатов
    - `stop_command` — тесты для администраторов и не-администраторов
    - `set_kandinsky_model_command` — тесты успешной установки и отсутствия аргументов
    - `set_gigachat_model_command` — тесты успешной установки, отсутствия клиента и отсутствия аргументов
    - `mod_command` — тесты успешного добавления администратора и отсутствия аргументов
    - `unmod_command` — тесты успешного удаления администратора и отсутствия аргументов
    - `list_mods_command` — тест вывода списка администраторов
    - `list_models_command` — тест вывода списка доступных моделей
  - `tests/test_bot/test_wednesday_bot.py` — добавлено 8 новых тестов:
    - `test_send_error_message` — тест отправки сообщения об ошибке
    - `test_send_user_friendly_error` — тест отправки дружелюбного сообщения об ошибке
    - `test_send_fallback_image_success` — тест успешной отправки fallback изображения
    - `test_send_fallback_image_no_image` — тест отсутствия fallback изображений
    - `test_on_my_chat_member_added` — тест обработки добавления бота в чат
    - `test_on_my_chat_member_removed` — тест обработки удаления бота из чата
    - `test_stop_bot` — тест остановки бота
    - `test_stop_bot_already_stopped` — тест повторной остановки уже остановленного бота
  - `tests/test_bot/test_support_bot.py` — добавлено 4 новых теста:
    - `test_help_command` — тест команды справки
    - `test_start_main_command_non_admin` — тест команды запуска основного бота для не-администратора
    - `test_start_main_command_admin_no_callback` — тест команды запуска без callback функции
    - `test_start_main_command_admin_with_callback` — тест команды запуска с callback функцией
    - `test_log_command_with_args` — тест команды отправки логов с аргументами
  - `tests/test_services/test_image_generator.py` — добавлено 6 новых тестов:
    - `test_get_random_caption` — тест получения случайной подписи
    - `test_get_fallback_prompt` — тест получения fallback промпта
    - `test_get_random_saved_image` — тесты получения случайного сохранённого изображения (с файлами и без)
    - `test_set_kandinsky_model_success` — тест успешной установки модели Kandinsky
    - `test_set_kandinsky_model_not_found` — тест установки несуществующей модели
    - `test_get_auth_headers` — тест получения заголовков авторизации
  - **Новые тестовые файлы для утилит**:
    - `tests/test_utils/test_admins_store.py` — 6 тестов для `AdminsStore`:
      - Добавление администратора (успешное и дубликат)
      - Удаление администратора (успешное и несуществующего)
      - Получение списка администраторов (обычный и полный с главным админом)
    - `tests/test_utils/test_dispatch_registry.py` — 4 теста для `DispatchRegistry`:
      - Проверка отсутствия записи
      - Создание и проверка записи
      - Обработка дубликатов
      - Очистка старых записей
    - `tests/test_utils/test_metrics.py` — 7 тестов для `Metrics`:
      - Инкремент успешных и неудачных генераций
      - Инкремент успешных и неудачных отправок
      - Добавление времени генерации
      - Инкремент срабатываний circuit breaker
      - Получение сводки метрик (пустая и заполненная)
    - `tests/test_utils/test_chats_store.py` — 4 теста для `ChatsStore`:
      - Добавление чата
      - Удаление чата
      - Получение списка чатов (с данными и пустой список)
- **Событийные метрики генераций и кеша в PostgreSQL**:
  - Добавлена таблица `metrics_events` (через `utils.postgres_schema.ensure_schema()` и SQL-миграции `docs/sql/003_add_metrics_events_table*.sql`) для логирования отдельных событий: ошибок, генераций, кеш-хитов/промахов, латентности и статуса.
  - Реализован helper `utils.metrics.record_metric(...)` c типизированным интерфейсом для записи событий и одновременным логированием через Loguru.
  - Добавлены агрегирующие запросы в `utils.metrics` (`get_daily_generation_stats`, `get_top_prompts`) для получения статистики по дням, средней латентности и топу промптов.
  - В `services/image_generator.ImageGenerator.generate_frog_image()` внедрена запись событий: `generation/started`, `generation/ok` с latency и `image_hash`, `cache_hit` с `status='cached'` и `latency_ms=0`, а также событий `error` при сетевых ошибках, срабатывании circuit breaker и полном провале генерации.
  - Обработчики `/frog` и `/force_send` передают `user_id` в генератор, чтобы привязывать события метрик к конкретным пользователям.
  - Запись событий вынесена в Redis Stream `metrics:events` через `record_metric`, а при недоступности Redis предусмотрен fallback на прямую запись в таблицу `metrics_events`, что снижает влияние метрик на latency горячего пути и готовит систему к асинхронным воркерам агрегации.
- **Тесты для `PromptStorage`** (`tests/test_services/test_prompt_generator.py`):
  - Проверка сохранения реального содержимого `"A frog"` без лишних кавычек и пробелов по краям.
  - Проверка корректной записи многострочных промптов с сохранением внутренних переводов строк и пробелов.
  - Проверка, что попытка сохранить пустой промпт приводит к `ValueError` и логируется через warning.
  - Небольшой тест, эмулирующий запись в директорию, ведущую себя как tmpfs‑volume в CI (через временную директорию pytest), для раннего отлова регрессий в файловых операциях с промптами.
- **Интеграционные тесты для команд бота**:
  - `tests/test_bot/test_handlers.py` — добавлены интеграционные тесты `test_status_command_integration_with_postgres_stores` и `test_force_send_command_integration_with_postgres_stores`, использующие реальные async‑сторы PostgreSQL для проверки работы команд `/status` и `/force_send`.
- **CI/CD с поддержкой PostgreSQL и Redis**:
  - `.github/workflows/pytest-check.yml` — добавлены сервисные контейнеры Postgres 16 и Redis 7 для запуска тестов в изолированной среде.
  - Настроены healthchecks для автоматического ожидания готовности БД перед запуском тестов.
  - Добавлена проверка готовности сервисов через Python‑скрипт перед выполнением тестов.
  - Используются безопасные тестовые учетные данные для изолированной CI‑среды.
- **Локальная тестовая инфраструктура**:
  - `docker-compose.test.yml` — отдельный docker-compose файл для тестовой среды с Postgres 16-alpine и Redis 7-alpine.
  - Контейнеры используют `tmpfs` для данных, обеспечивая быструю очистку после тестов и изоляцию от продакшн БД.
  - `Makefile` — разделены команды тестирования: `make test` (только тесты + junit.xml), `make test-cov` (тесты с покрытием + coverage.xml + junit.xml).
  - Команды тестирования автоматически запускают тестовые контейнеры, ждут их готовности, выполняют тесты и очищают контейнеры после завершения.
  - Добавлены вспомогательные команды: `make test-up` (запуск контейнеров), `make test-down` (остановка), `make test-no-containers` (запуск тестов без контейнеров для уже запущенных БД).
- **Боевой запуск через Docker**:
  - `Makefile` — команда `make run` полностью переработана: автоматически очищает и пересобирает Docker-образ бота, поднимает боевые контейнеры Postgres и Redis, ожидает их готовности и запускает бота.
  - Команда `make build` теперь автоматически очищает старый образ перед сборкой нового.
  - Удалены неиспользуемые команды: `run-local`, `init-volumes`, `sync-volumes`.
- **Docker volumes для файловых операций**:
  - `docker-compose.yml` — добавлены именованные тома:
    - `frog_images` → примонтирован в контейнер по пути `/app/data/frogs` для хранения сгенерированных изображений жабы.
    - `logs` → примонтирован в контейнер по пути `/app/logs` для файлов логов бота.
    - `prompt_storage` → примонтирован в контейнер по пути `/app/data/prompts` для файлового хранилища промптов GigaChat.
  - Весь файловый ввод/вывод бота (изображения, логи, промпты) переведён на работу только с этими директориями внутри контейнера.
  - Добавлены рекомендации по резервному копированию томов в `README.md` и `docs/INSTALLATION.md`.
  - Таблица `prompts` используется как каноничное хранилище метаданных промптов (raw/normalized/hash), а файловый `prompt_storage` служит fallback-слоем.
- **PostgreSQL-хранилище промптов**:
  - Добавлена таблица `prompts` (через `utils/postgres_schema.ensure_schema()` и SQL-миграции `docs/sql/001_add_prompts_table*.sql`) с полями `raw_text`, `normalized_text`, `prompt_hash`, `created_at`, `ab_group` и индексом `idx_prompts_prompt_hash`.
  - Реализован репозиторий `utils/prompts_store.PromptsStore` с методами `get_or_create_prompt`, `get_prompt_by_hash`, `get_random_prompt`, нормализующий текст промпта (strip) и считающий sha256‑hash от нормализованного текста.
  - `services/image_generator.ImageGenerator._generate_prompt()` теперь регистрирует все успешные промпты (GigaChat + fallback) в таблице `prompts` и использует БД как основной источник промптов при недоступности GigaChat.
  - Добавлены тесты `tests/test_utils/test_prompts_store.py` и `tests/test_utils/test_prompts_migration_sql.py`, проверяющие корректность схемы, дедупликацию по hash и возможность применения/отката миграций.
- **PostgreSQL-хранилище изображений и content-addressable storage**:
  - Добавлена таблица `images` в `utils/postgres_schema.ensure_schema()` и SQL-миграции `docs/sql/002_add_images_table*.sql` с полями `image_hash`, `prompt_hash` (FK на `prompts.prompt_hash`), `path`, `created_at` и индексом `idx_images_prompt_hash`.
  - Реализован репозиторий `utils/images_store.ImagesStore` c content-addressable схемой: имя файла изображения вычисляется как `sha256(image_bytes).hexdigest()` и используется как ключ `image_hash`, файл хранится как `/app/data/frogs/<image_hash>.png`.
  - Добавлены тесты `tests/test_utils/test_images_store.py` и `tests/test_utils/test_images_migration_sql.py`, покрывающие базовые операции, применение/откат миграций и обработку гонок при параллельной вставке (duplicate key → reuse существующей записи).
  - Внедрён кеш изображений по `prompt_hash` в `services/image_generator.ImageGenerator.generate_frog_image()`: при повторном запросе с тем же нормализованным промптом бот сначала ищет запись в `images` и при наличии использует уже сохранённый файл (cache hit) без обращения к Kandinsky.
  - Логика генерации и сохранения изображений переписана на строгий content-addressable storage‑паттерн: сначала вычисляется `image_hash = sha256(file_bytes).hexdigest()`, затем файл атомарно сохраняется во временный путь и переносится в конечный `/app/data/frogs/<image_hash>.png` без перезаписи уже существующих файлов.
- **Workflow `docker-build.yml`, `Dockerfile`, `.dockerignore`**:
  - Автоматически создаёт Docker image на основе `Dockerfile` и пушит его в GHCR.
- **Логика ленивой загрузки `.env` в `utils/config.py`**:
  - Переменные конфигурации сначала читаются из окружения контейнера (`os.environ`).
  - При отсутствии значения для переменной один раз выполняется fallback через `python-dotenv` без жёстких путей к `.env`.
  - Добавлено логирование ошибок через стандартный `logging` для всех отсутствующих обязательных переменных.
- **Файловое хранилище промптов GigaChat в `services/prompt_generator.py`**:
  - Все успешно сгенерированные промпты GigaChat автоматически сохраняются в директорию `data/prompts/` в виде текстовых файлов.
  - Директория `data/prompts/` создаётся на лету при первом обращении, без необходимости ручной подготовки.
  - Структура хранилища (имена файлов, пометка источника) подготовлена для последующего A/B-тестирования разных вариантов промптов.
- **Файловый fallback-промпт в `services/image_generator.py`**:
  - При любой ошибке GigaChat (таймаут, недоступность API, сетевые проблемы) генератор изображений пробует выбрать случайный промпт из сохранённых файлов `data/prompts/`.
  - Для всех операций добавлено расширенное логирование через `loguru`, а маршруты файлов привязаны к volume‑путям `/app/data/prompts` и `/app/data/frogs` внутри контейнера.

### Изменено

- Система логирования (`utils/logger.py`):
  - ротация логов переведена на размер‑ориентированный режим (`rotation="10 MB"`) с retention `7 days`;
  - все логи пишутся в единый файл `wednesday_bot.log` в директории `logs/` (в Docker — volume `/app/logs`);
  - декоратор `log_execution` теперь автоматически редактирует потенциально чувствительные kwargs
    (ключи, токены, пароли и т.п.) — значения заменяются на `<redacted>`, чтобы предотвратить утечку секретов.
  - **Улучшена система автоматического логирования методов**:
    - Декоратор `@log_execution` теперь поддерживает параметры `level` (DEBUG, INFO, WARNING, ERROR), `log_args` и `log_result` для гибкой настройки логирования отдельных методов.
    - Декоратор `@log_all_methods()` получил новые параметры:
      - `skip_private=True` (по умолчанию) — автоматически исключает приватные методы (начинающиеся с `_`) из логирования, что значительно снижает объём логов от служебных методов.
      - `default_level="INFO"` — уровень логирования по умолчанию для публичных методов.
      - `method_levels` — словарь для явного указания уровня логирования для конкретных методов (например, `{"critical_method": "ERROR"}`).
    - Приватные методы, если они не исключены, автоматически логируются на уровне DEBUG вместо INFO, что позволяет включать их при необходимости без засорения основных логов.
    - Сохранена полная обратная совместимость: существующие использования `@log_all_methods()` работают как раньше, но теперь по умолчанию исключают приватные методы.
- PostgreSQL‑миграции:
  - модуль `utils/postgres_schema.py` получил точку входа `python -m utils.postgres_schema`, позволяющую
    запускать идемпотентную инициализацию схемы через `make migrate` и в CI.
- Инфраструктура тестов и CI:
  - `tests/test_utils/test_images_store.py` и `tests/test_utils/test_prompts_store.py` дополнены явными
    тестами гонок (`asyncio.gather`) для проверки корректности upsert‑логики при параллельной вставке в БД;
  - `Makefile` расширен целями `migrate` и обновлённой целью `ci` (lint → type → migrate → test-cov → build);
  - добавлен workflow `.github/workflows/ci.yml`, выполняющий lint, mypy, миграции, pytest с покрытием
    и сборку Docker‑образа с использованием сервисных контейнеров PostgreSQL и Redis.

### Откат

- **Схема БД**:
  - для отката таблицы `metrics_events` используйте SQL‑скрипт `docs/sql/003_add_metrics_events_table_down.sql`
    (выполнить `DROP TABLE IF EXISTS metrics_events CASCADE;`);
  - для полного возврата к предыдущей схеме можно последовательно выполнить `*_down.sql` миграции в `docs/sql/`.
- **Docker и volumes**:
  - чтобы временно отключить volume‑хранилища, можно убрать тома `frog_images`, `logs`, `prompt_storage`
    из `docker-compose.yml` и вернуть локальные пути в `utils/paths.py` к прежнему виду (до `/app/...`);
  - для удаления всех данных volumes в dev/CI окружении используйте `docker compose down -v`.
- **CI/Makefile**:
  - при необходимости возврата к старому пайплайну достаточно удалить workflow `ci.yml` и вернуть цель `ci`
    в `Makefile` к предыдущей конфигурации (без шагов `migrate` и `build`).
  - Если в файловом хранилище нет ни одного промпта, используется существующий статический fallback на основе `ImageConfig.FROG_PROMPTS`.
  - Добавлено подробное логирование выбора и использования fallback-промптов.
- **Единый Redis‑клиент `utils/redis_client.py`**:
  - Асинхронный клиент `redis.asyncio.Redis` с инициализацией один раз за цикл жизни приложения.
  - Функции `init_redis_pool()`, `get_redis()`, `close_redis()`, `redis_available()` для централизованного доступа.
  - Лёгкий in‑memory fallback с поддержкой TTL, используемый при недоступности Redis.
- **Сервисы Redis‑абстракций**:
  - `services/prompt_cache.py` — кэш промптов (JSON‑совместимых объектов) с TTL и автоматическим fallback.
  - `services/user_state_store.py` — хранилище временного состояния пользователей (JSON‑blob, TTL + очистка).
  - `services/rate_limiter.py` — `RateLimiter` c фиксированным окном и `CircuitBreaker` на базе атомарных операций Redis.
- **Интеграция Redis в ботов и раннер**:
  - `main.py` — при старте пробует инициализировать Redis (по `REDIS_URL` или `REDIS_HOST/PORT/DB/PASSWORD`), при ошибке продолжает работу в деградированном in‑memory режиме.
  - `bot/wednesday_bot.py` — размещает `PromptCache`, `UserStateStore` и `RateLimiter` в `bot_data` для использования обработчиками.
  - `bot/support_bot.py` — добавлен `RateLimiter` для административных команд резервного бота (fail‑open при недоступности Redis).
- **Redis‑основанный circuit breaker для Kandinsky**:
  - `services/image_generator.py` использует `CircuitBreaker` из `services/rate_limiter.py` для подсчёта неудач и окна восстановления поверх Redis.
- **Тесты для Redis‑сервисов**:
  - `tests/test_services/test_redis_services.py` — базовые проверки `PromptCache`, `UserStateStore`, `RateLimiter` и `CircuitBreaker` на in‑memory backend.
 - **PostgreSQL‑клиент и схема БД**:
   - `utils/postgres_client.py` — асинхронный клиент PostgreSQL с одним пулом `asyncpg.Pool` на всё приложение и вспомогательными функциями `init_postgres_pool()`, `get_postgres_pool()`, `close_postgres_pool()`.
   - `utils/postgres_schema.py` — инициализация схемы БД через идемпотентную функцию `ensure_schema()`, создающую необходимые таблицы (`chats`, `admins`, `usage_stats`, `usage_settings`, `dispatch_registry`, `metrics`, `models_kandinsky`, `models_gigachat`).
 - **PostgreSQL‑репозитории вместо JSON‑файлов**:
   - `utils/chats_store.py` — `ChatsStore` переведён на хранение в таблице `chats` (список чатов рассылки).
   - `utils/admins_store.py` — `AdminsStore` использует таблицу `admins` для хранения доп. администраторов (главный по‑прежнему задаётся через `ADMIN_CHAT_ID`).
   - `utils/usage_tracker.py` — `UsageTracker` хранит помесячную статистику в `usage_stats` и настройки лимитов в `usage_settings`.
   - `utils/dispatch_registry.py` — `DispatchRegistry` отслеживает отправки по слотам в таблице `dispatch_registry` вместо `dispatch_registry.json`.
   - `utils/metrics.py` — `Metrics` агрегирует показатели в таблице `metrics` (единая строка `id=1`) вместо `metrics.json`.
   - `utils/models_store.py` — `ModelsStore` разбит на две таблицы: `models_kandinsky` и `models_gigachat` для текущих и доступных моделей.
 - **Документация и запуск**:
   - `README.md` обновлён под новую архитектуру: Postgres‑сторы вместо JSON‑файлов, единый Redis‑клиент и быстрый старт через `docker compose up`.
  - `docs/INSTALLATION.md` переработан: добавлен основной сценарий запуска через `docker-compose` (Postgres + Redis + бот), убраны упоминания JSON‑хранилищ метрик/usage, описаны варианты нативного запуска, добавлено описание Docker volumes для изображений, логов и промптов.
   - `docs/PROJECT_SUMMARY.md` обновлён: разделы по `ChatsStore`, `UsageTracker`, `DispatchRegistry`, `Metrics`, `ModelsStore` переписаны под PostgreSQL, структура `utils/` дополнена `redis_client.py`, `postgres_client.py`, `postgres_schema.py`.
 - **Async-проводка бота и тестов для работы с Postgres**:
   - `bot/wednesday_bot.py` — методы отправки жабы и обработки добавления/удаления чатов теперь используют async‑репозитории (`ChatsStore`, `DispatchRegistry`, `UsageTracker`, `Metrics`, `AdminsStore`) через `await`, без изменения внешнего API.
   - `bot/support_bot.py` — проверки прав администратора и рассылка уведомлений обрабатываются через async‑интерфейс `AdminsStore`.
   - `bot/handlers.py` — все админ‑команды и команды работы с лимитами/чатами/статусом (`/help`, `/frog`, `/status`, `/force_send`, `/add_chat`, `/remove_chat`, `/list_chats` и др.) переведены на использование async‑сторов (`AdminsStore`, `UsageTracker`, `ChatsStore`, `Metrics`) с `await`.
   - `services/image_generator.py` — обновление метрик генерации (`Metrics`) выполняется асинхронно с защитой от сбоев в слое метрик.
   - `tests/conftest.py` — добавлена сессионная async‑фикстура `_setup_test_postgres`, инициализирующая пул `asyncpg`, вызывающая `ensure_schema()` и очищающая основные таблицы перед тестами.
   - `tests/test_utils/test_usage_tracker.py`, `tests/test_utils/test_models_store.py` — переписаны как async‑тесты поверх Postgres‑репозиториев.
   - `tests/test_bot/test_wednesday_bot.py`, `tests/test_bot/test_support_bot.py` — заглушки (`Dummy*Store`, `DummyMetrics`) приведены к async‑интерфейсам, чтобы соответствовать новым async‑сторам.
 - **Расширенное тестовое покрытие**:
   - `tests/test_bot/test_handlers.py` — добавлено 20+ новых тестов для команд:
     - `set_frog_used_command` — тесты успешного выполнения, неверных параметров и отсутствия аргументов
     - `unknown_command` — тест обработки неизвестных команд
     - `admin_add_chat_command` — тесты успешного добавления, отсутствия аргументов и неверного chat_id
     - `admin_remove_chat_command` — тесты успешного удаления и отсутствия аргументов
     - `list_chats_command` — тесты успешного вывода списка и пустого списка чатов
     - `stop_command` — тесты для администраторов и не-администраторов
     - `set_kandinsky_model_command` — тесты успешной установки и отсутствия аргументов
     - `set_gigachat_model_command` — тесты успешной установки, отсутствия клиента и отсутствия аргументов
     - `mod_command` — тесты успешного добавления администратора и отсутствия аргументов
     - `unmod_command` — тесты успешного удаления администратора и отсутствия аргументов
     - `list_mods_command` — тест вывода списка администраторов
     - `list_models_command` — тест вывода списка доступных моделей
   - `tests/test_bot/test_wednesday_bot.py` — добавлено 8 новых тестов:
     - `test_send_error_message` — тест отправки сообщения об ошибке
     - `test_send_user_friendly_error` — тест отправки дружелюбного сообщения об ошибке
     - `test_send_fallback_image_success` — тест успешной отправки fallback изображения
     - `test_send_fallback_image_no_image` — тест отсутствия fallback изображений
     - `test_on_my_chat_member_added` — тест обработки добавления бота в чат
     - `test_on_my_chat_member_removed` — тест обработки удаления бота из чата
     - `test_stop_bot` — тест остановки бота
     - `test_stop_bot_already_stopped` — тест повторной остановки уже остановленного бота
   - `tests/test_bot/test_support_bot.py` — добавлено 4 новых теста:
     - `test_help_command` — тест команды справки
     - `test_start_main_command_non_admin` — тест команды запуска основного бота для не-администратора
     - `test_start_main_command_admin_no_callback` — тест команды запуска без callback функции
     - `test_start_main_command_admin_with_callback` — тест команды запуска с callback функцией
     - `test_log_command_with_args` — тест команды отправки логов с аргументами
   - `tests/test_services/test_image_generator.py` — добавлено 6 новых тестов:
     - `test_get_random_caption` — тест получения случайной подписи
     - `test_get_fallback_prompt` — тест получения fallback промпта
     - `test_get_random_saved_image` — тесты получения случайного сохранённого изображения (с файлами и без)
     - `test_set_kandinsky_model_success` — тест успешной установки модели Kandinsky
     - `test_set_kandinsky_model_not_found` — тест установки несуществующей модели
     - `test_get_auth_headers` — тест получения заголовков авторизации
   - **Новые тестовые файлы для утилит**:
     - `tests/test_utils/test_admins_store.py` — 6 тестов для `AdminsStore`:
       - Добавление администратора (успешное и дубликат)
       - Удаление администратора (успешное и несуществующего)
       - Получение списка администраторов (обычный и полный с главным админом)
     - `tests/test_utils/test_dispatch_registry.py` — 4 теста для `DispatchRegistry`:
       - Проверка отсутствия записи
       - Создание и проверка записи
       - Обработка дубликатов
       - Очистка старых записей
     - `tests/test_utils/test_metrics.py` — 7 тестов для `Metrics`:
       - Инкремент успешных и неудачных генераций
       - Инкремент успешных и неудачных отправок
       - Добавление времени генерации
       - Инкремент срабатываний circuit breaker
       - Получение сводки метрик (пустая и заполненная)
     - `tests/test_utils/test_chats_store.py` — 4 теста для `ChatsStore`:
       - Добавление чата
       - Удаление чата
       - Получение списка чатов (с данными и пустой список)

### Изменено
- **`services/prompt_generator.py` / `PromptStorage`**:
  - Добавлена нормализация промптов перед записью в файловое хранилище: удаляются ведущие и замыкающие пробелы по всему промпту, при этом внутренняя многострочная структура не изменяется.
  - Реализована фильтрация управляющих символов (кроме перевода строки), чтобы в файлы `data/prompts` не попадали невидимые управляющие коды.
  - Логика записи переписана на явное использование `open(..., encoding="utf-8")` и логируется hash содержимого и ожидаемый контейнерный путь `/app/data/prompts/<filename>`.
  - При пустом промпте после нормализации или очистки управляющих символов выбрасывается `ValueError` и пишется предупреждение в логах; вызывающий код обрабатывает ошибку как некритичную.
- **`utils/config.py`**:
  - Обязательные переменные конфигурации (`TELEGRAM_BOT_TOKEN`, `KANDINSKY_API_KEY`, `KANDINSKY_SECRET_KEY`, `CHAT_ID`, `ADMIN_CHAT_ID`) теперь полностью завязаны на переменные окружения контейнера с fallback на локальный `.env`.
  - Опциональные переменные (`GIGACHAT_AUTHORIZATION_KEY`, `SCHEDULER_SEND_TIMES`, `SCHEDULER_WEDNESDAY_DAY`, `SCHEDULER_TZ` и др.) также читаются через единый слой доступа к окружению с поддержкой fallback.
  - Сообщение об ошибке при отсутствии обязательных переменных теперь явно указывает на необходимость проверки окружения контейнера и/или локального `.env`.
  - Функция `_load_dotenv_if_needed()` обёрнута в `try-except` для graceful handling ошибок доступа к `.env` (например, `PermissionError` при отсутствии прав чтения), что позволяет тестам работать без локального `.env` файла.
- **`tests/conftest.py`**:
  - Фикстура `base_env` теперь устанавливает безопасные тестовые значения для Postgres (`test_user`/`test_password_ci_2024`) вместо реальных учетных данных.
  - Добавлены переменные окружения `SCHEDULER_SEND_TIMES`, `SCHEDULER_WEDNESDAY_DAY`, `SCHEDULER_TZ` в `base_env` для предотвращения вызовов `load_dotenv()` при инициализации `SchedulerConfig` во время коллекции тестов.
- **`.github/workflows/pytest-check.yml`**:
  - Убраны хардкод реальных паролей БД из workflow файла; используются безопасные тестовые значения (`test_user`/`test_password_ci_2024`) только для изолированной CI‑среды.
  - Добавлены переменные окружения для Postgres и Redis на уровне job'а для корректной работы тестов в CI.
- **`docker-compose.yml`**:
  - Добавлены healthchecks для Postgres и Redis для контроля готовности сервисов.
  - Сервис `bot` теперь использует только образ `wednesday-bot:local` (без секции `build`), который собирается через `make build`.
  - Добавлены `depends_on` с условиями `service_healthy` для гарантированного запуска бота только после готовности БД.
  - Сервис `bot` переопределяет `POSTGRES_HOST` и `REDIS_HOST` для работы внутри Docker-сети.
- **`Makefile`**:
  - Команда `make test` разделена на две: `make test` (без покрытия, только junit.xml) и `make test-cov` (с покрытием, coverage.xml + junit.xml).
  - Команда `make run` переработана для полного боевого запуска: сборка образа, поднятие БД, ожидание готовности сервисов, запуск бота.
  - Команда `make build` автоматически очищает старый образ перед сборкой нового.
  - Команда `make ci` обновлена: использует `make test-cov` и добавлена проверка форматирования через `make format-check`.
  - Удалены неиспользуемые команды: `run-local`, `init-volumes`, `sync-volumes`.
- **`main.py`**:
  - Удалена жёсткая проверка наличия файла `.env` и любые обращения к `Path(".env")`.
  - `_check_requirements()` больше не зависит от наличия `.env`, а опирается на валидацию и загрузку конфигурации в `utils.config`.
  - Добавлено логирование факта наличия/отсутствия ключевых переменных (`TELEGRAM_BOT_TOKEN`, `KANDINSKY_API_KEY`, `KANDINSKY_SECRET_KEY`, `CHAT_ID`, `ADMIN_CHAT_ID`) при старте бота.
  - Добавлена инициализация пула PostgreSQL (`init_postgres_pool`) и вызов `ensure_schema()` перед запуском ботов; при ошибке подключения к Postgres запуск прерывается.
 - **`services/prompt_generator.py`**:
   - Добавлен класс `PromptStorage` с ответственностью за создание директории `data/prompts/`, сохранение и выбор случайного промпта из файлов.
   - `GigaChatClient` теперь сохраняет каждый успешно сгенерированный промпт в файловое хранилище для дальнейшего анализа и reuse.
 - **`services/image_generator.py`**:
   - Логика генерации промптов через GigaChat вынесена в отдельный слой с явным файловым fallback: при сбое GigaChat используется случайный промпт из `data/prompts/`.
   - Логика построена так, чтобы в будущем было просто подменить стратегию получения промптов (разные A/B-варианты, иные источники), не трогая основной код генерации изображений.
- **`env_example.txt`**:
  - Добавлены переменные `REDIS_URL`, `REDIS_HOST`, `REDIS_PORT`, `REDIS_DB`, `REDIS_PASSWORD` для конфигурации Redis.
- **`utils/config.py`**:
  - Добавлены свойства `redis_url`, `redis_host`, `redis_port`, `redis_db`, `redis_password` c дефолтными значениями.
  - Добавлены свойства `postgres_user`, `postgres_password`, `postgres_db`, `postgres_host`, `postgres_port` для конфигурации PostgreSQL с разумными значениями по умолчанию.
- **`services/image_generator.py`**:
  - Встроенный in‑memory circuit‑breaker заменён на Redis‑базированный `CircuitBreaker`, с сохранением минимального локального состояния для обратной совместимости логов.
  - Добавлен слой кеширования изображений по `prompt_hash` поверх таблицы `images`: при повторной генерации с тем же нормализованным промптом бот сначала ищет запись в `images` и при наличии использует уже сохранённый файл (cache hit), а не обращается к Kandinsky.
  - Логика сохранения изображений переписана на content-addressable storage: сначала вычисляется `image_hash = sha256(file_bytes).hexdigest()`, затем файл атомарно сохраняется во временный путь и переносится в конечный `/app/data/frogs/<image_hash>.png` без перезаписи уже существующих файлов.
  - Добавлено подробное логирование этапов генерации и кеширования (start gen, cache hit, save file, db insert, race condition handled, fallback на живую генерацию при потере файла на диске).
- **Тестовая инфраструктура**:
  - `tests/conftest.py` — добавлена фикстура `cleanup_tables` для автоматической очистки таблиц между тестами, обеспечивающая полную изоляцию тестов
  - Все фикстуры для `UsageTracker`, `ModelsStore`, `AdminsStore` теперь полностью асинхронные и корректно работают с PostgreSQL
  - Фикстура `_setup_test_postgres` изменена с `scope="session"` на `scope="function"` для пересоздания пула PostgreSQL в каждом тесте, что решает проблему конфликтов event loop между тестами
  - Добавлены тестовые переменные окружения PostgreSQL в `_session_env_defaults` для принудительного использования тестовых значений независимо от системных переменных
- **Покрытие тестами**:
  - Общее покрытие кода выросло с 43% до 65% (+22 процентных пункта)
  - Добавлено 50+ новых тестов для критичных компонентов бота и утилит
  - Все тесты используют реальные PostgreSQL хранилища для интеграционного тестирования
- **Тестовые заглушки**:
  - `tests/test_bot/test_wednesday_bot.py` — добавлены методы `add_chat` и `remove_chat` в `DummyChatsStore` для корректной работы тестов `on_my_chat_member`
  - Тесты для команд управления администраторами (`mod_command`, `unmod_command`, `list_mods_command`) используют реальный `AdminsStore` с перезагрузкой модуля для обхода патчей в `conftest.py`
- **Docker Compose для тестов**:
  - `docker-compose.test.yml` — удалён устаревший атрибут `version: "3.9"` (совместимо с современными версиями Docker Compose)
- **Конфигурация pytest-asyncio**:
  - `pyproject.toml` — изменён `asyncio_mode` с `"auto"` на `"strict"` для использования одного event loop для всех тестов

### Исправлено
- **`utils/config.py`**:
  - Обработка `PermissionError` и других исключений при загрузке `.env` файла: добавлен `try-except` блок в `_load_dotenv_if_needed()` для graceful fallback, позволяющий тестам работать без локального `.env` файла или при отсутствии прав доступа.
- **`utils/postgres_client.py`**:
  - Исправлена ошибка "Event loop is closed" при закрытии Postgres пула: добавлена проверка состояния event loop перед закрытием пула и обработка `RuntimeError` с проверкой конкретной причины. Улучшено логирование для различения нормального shutdown и реальных ошибок. Ошибки "Event loop is closed" больше не засоряют логи при нормальном завершении приложения.
- **`services/prompt_generator.py`**:
  - Улучшена диагностика аутентификации GigaChat: добавлена проверка наличия `authorization_key` перед использованием, диагностическое логирование (без вывода полного ключа) и улучшено сообщение об ошибке с указанием возможных причин. Теперь легче диагностировать проблемы с настройкой ключа GigaChat.
- **`services/image_generator.py`**:
  - Улучшена обработка ошибок сохранения файлов: добавлена специфичная обработка `PermissionError` (проблемы с правами доступа) и `OSError` (проблемы файловой системы, нехватка места). Улучшены сообщения об ошибках для каждой категории проблем. Добавлен `exc_info=True` для полного стека при неожиданных ошибках. Более понятные сообщения об ошибках сохранения файлов.
- **`bot/handlers.py`**:
  - Исправлена обработка ошибок валидации: исправлен `raise ValueError` без сообщения → теперь с понятным сообщением. Логи теперь содержат понятное сообщение об ошибке валидации.
- **Типизация и стиль кода**:
  - Устранены все ошибки типизации `mypy`: добавлены `await` для всех асинхронных вызовов в `services/prompt_generator.py`, `services/image_generator.py`, `bot/handlers.py`, `bot/wednesday_bot.py`, `bot/support_bot.py`.
  - Исправлены ошибки `ruff` линтинга (`RUF029`, `F821`): добавлены недостающие `await` в тестах, перемещены определения классов внутри функций где необходимо.
  - Исправлены несовместимые типы и присвоения: корректные type hints для `gigachat_ok` и `current_gigachat` в `bot/handlers.py`, правильная обработка `Optional` типов.
- **Безопасность**:
  - Удалён хардкод реальных паролей БД из `.github/workflows/pytest-check.yml` и `tests/conftest.py`; используются безопасные тестовые значения только для изолированной CI‑среды.
- **Тесты**:
  - Исправлена проблема с `PermissionError` при запуске `pytest` из‑за попытки загрузки `.env` во время коллекции тестов: добавлены переменные планировщика в `base_env` фикстуру для предотвращения преждевременной загрузки `.env`.
- **Критические ошибки асинхронности в обработчиках команд**:
  - `bot/handlers.py` — исправлены все отсутствующие `await` для асинхронных вызовов:
    - `usage.increment(1)` → `await usage.increment(1)` (строки 659, 1247)
    - `self.admins_store.is_admin(user_id)` → `await self.admins_store.is_admin(user_id)` (строки 1081, 1640, 1697, 1773, 1828)
    - `self.admins_store.add_admin(user_id)` → `await self.admins_store.add_admin(user_id)` (строка 1666)
    - `self.admins_store.remove_admin(user_id)` → `await self.admins_store.remove_admin(user_id)` (строка 1739)
  - `bot/wednesday_bot.py` — исправлен отсутствующий `await` для `is_dispatched`:
    - `self.dispatch_registry.is_dispatched(...)` → `await self.dispatch_registry.is_dispatched(...)` (строка 292)
  - Устранены ошибки типа `TypeError: 'bool' object can't be awaited` и `RuntimeError: Task <Task pending>`
  - Устранены конфликты корутин при параллельных операциях с Postgres и Redis
- **Проблемы с event loop в тестах**:
  - `utils/postgres_client.py` — добавлена проверка и пересоздание пула PostgreSQL, если он был создан в другом event loop (решает проблему `RuntimeError: Task <Task pending> got Future attached to a different loop`)
  - `tests/conftest.py` — фикстура `_setup_test_postgres` теперь пересоздаёт пул для каждого теста, если он был создан в другом loop, обеспечивая корректную работу с `pytest-asyncio`
  - Исправлена проблема с использованием системных переменных окружения PostgreSQL вместо тестовых значений: добавлены принудительные тестовые значения в `_session_env_defaults`
- **Ошибки в тестах**:
  - Исправлены тесты `test_mod_command_success`, `test_unmod_command_success`, `test_list_mods_command_success` — теперь используют реальный `AdminsStore` с перезагрузкой модуля для корректной работы с PostgreSQL
  - Исправлен тест `test_on_my_chat_member_added` — добавлены методы `add_chat` и `remove_chat` в `DummyChatsStore`
  - Исправлен тест `test_start_main_command_admin_no_callback` — упрощена проверка результата выполнения команды
  - Исправлен тест `test_log_command_with_args` — улучшена работа с временными директориями для логов
- **Ошибки в коде**:
  - `utils/dispatch_registry.py` — исправлена обработка `slot_date` в методе `mark_dispatched`: добавлено преобразование строки в объект `date` через `date.fromisoformat()` для корректной работы с asyncpg (устранена ошибка `DataError: invalid input for query argument $2`)
  - Убран явный каст `$2::date` из SQL запроса, так как asyncpg корректно обрабатывает объекты `date` напрямую

### Поведение и заметки по миграции
- Redis используется только для временного состояния, кэшей и счётчиков: при его недоступности вся критичная бизнес‑логика продолжает работать, опираясь на in‑memory fallback.
- Лимитер `RateLimiter` сознательно настроен в режиме *fail‑open* при ошибках Redis, чтобы инфраструктурные сбои не блокировали пользователей. Для доменов с жёсткими требованиями по лимитам рекомендуется изменить политику на *fail‑closed*.
- Circuit‑breaker для Kandinsky теперь разделяет состояние между инстансами и переживает рестарты, что снижает нагрузку на внешний API при массовых ошибках.

---

services:
  postgres:
    image: postgres:16-alpine
    container_name: wednesday_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - wednesday_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: wednesday_redis
    restart: unless-stopped
    command: >
      sh -c "
      if [ -n \"$$REDIS_PASSWORD\" ]; then
        redis-server --appendonly yes --requirepass \"$$REDIS_PASSWORD\"
      else
        redis-server --appendonly yes
      fi
      "
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - wednesday_redis_data:/data
    healthcheck:
      test: >
        sh -c "
        if [ -n \"$$REDIS_PASSWORD\" ]; then
          redis-cli -a \"$$REDIS_PASSWORD\" ping
        else
          redis-cli ping
        fi
        "
      interval: 5s
      timeout: 3s
      retries: 5

  bot:
    image: wednesday-bot:local
    container_name: wednesday_bot
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - .env
    environment:
      # Переопределяем хосты для работы внутри docker-сети
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
    volumes:
      # Хранилище сгенерированных изображений жабы.
      # Внутри контейнера бот читает/пишет только в /app/data/frogs.
      - frog_images:/app/data/frogs
      # Персистентные логи приложения.
      # Внутри контейнера логгер пишет только в /app/logs.
      - logs:/app/logs
      # Хранилище промптов GigaChat (файловый fallback).
      # Внутри контейнера промпты сохраняются в /app/data/prompts.
      - prompt_storage:/app/data/prompts
    networks:
      - default

volumes:
  wednesday_postgres_data:
  wednesday_redis_data:
  frog_images:
  logs:
  prompt_storage:
